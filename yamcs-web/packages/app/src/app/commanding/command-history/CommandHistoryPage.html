<app-instance-page>
  <app-instance-toolbar [hasDetailPane]="true">Command History</app-instance-toolbar>

  <app-detail-pane>
    <ng-container *ngIf="selectedRecord$ | async as selectedRecord; else noSelection">
      <app-detail-toolbar>
        Command Detail
      </app-detail-toolbar>
      <div style="padding: 0 16px">
        <h6>Command</h6>
        <div class="block">
          <a [routerLink]="['/mdb/commands', selectedRecord.commandName]"
             [queryParams]="{instance: instance.name}"
             class="ya-link">
            {{ selectedRecord.commandName }}
          </a>
        </div>

        <h6>Time</h6>
        <div class="block">
          {{ selectedRecord.generationTime | datetime }}
        </div>

        <h6>Issuer</h6>
        <div class="block">
          {{ selectedRecord.username }}<ng-container *ngIf="selectedRecord.origin">@{{ selectedRecord.origin }}</ng-container>
        </div>

        <h6>
          Sequence Number
          <app-help>
            <p>The <strong>Sequence Number</strong> is a number assigned by the client that issued the command. It is used by Yamcs to establish unicity to other commands with the same time and issuer.</p>
            <p>Note in particular that this value does not have any correlation with sequence numbers that may be encoded in the telecommand packet (e.g. CCSDS Sequence Number).</p>

          </app-help>
        </h6>
        <div class="block">
          {{ selectedRecord.sequenceNumber }}
        </div>

        <mat-divider style="margin-top: 1em; margin-bottom: 1em"></mat-divider>

        <h6 style="padding-top: 0">Source</h6>
        <div class="block">
          {{ selectedRecord.source || '-' }}
        </div>

        <h6>Binary</h6>
        <div class="block">
          <app-hex [base64String]="selectedRecord.binary"></app-hex>
        </div>

        <ng-container *ngIf="selectedRecord.comment">
          <mat-divider style="margin-top: 1em; margin-bottom: 1em"></mat-divider>
          <h6 style="padding-top: 0">Comment</h6>
          <div class="block">
            {{ selectedRecord.comment }}
          </div>
        </ng-container>

        <ng-container *ngIf="selectedRecord.extra.length">
          <mat-divider style="margin-top: 1em; margin-bottom: 1em"></mat-divider>
          <h6 style="padding-top: 0">Extra Attributes</h6>
          <div class="block">
            <ul>
              <li *ngFor="let extra of selectedRecord.extra">{{ extra.name }}: {{ extra.value }}</li>
            </ul>
          </div>
        </ng-container>

        <ng-container *ngIf="selectedRecord.stages.length">
          <mat-divider style="margin-top: 1em; margin-bottom: 1em"></mat-divider>
          <h6 style="padding-top: 0">Stages</h6>
          <div class="block">
            <table yaDataTable style="width: 100%">
              <tr>
                <th style="width: 16px"></th>
                <th></th>
                <th>Status</th>
                <th>Time</th>
              </tr>
              <tr *ngFor="let stage of selectedRecord.stages">
                <td>
                  <ng-container [ngSwitch]="stage.status">
                    <ng-container *ngSwitchCase="'OK'">
                      <mat-icon class="step success" style="margin-right: 8px">
                        check_circle
                      </mat-icon>
                    </ng-container>
                    <ng-container *ngSwitchCase="'TIMEOUT'">
                      <mat-icon class="step alert" style="margin-right: 8px">
                        timer_off
                      </mat-icon>
                    </ng-container>
                    <ng-container *ngSwitchDefault>
                      <mat-icon class="step alert" style="margin-right: 8px">
                        highlight_off
                      </mat-icon>
                    </ng-container>
                  </ng-container>
                </td>
                <td>{{ stage.name }}</td>
                <td>{{ stage.status }}</td>
                <td>
                  <span [matTooltip]="stage.time">{{ stage.time | deltaWith:selectedRecord.generationTime }}</span>
                </td>
              </tr>
            </table>
          </div>
        </ng-container>

        <p>&nbsp;</p>
      </div>
    </ng-container>
    <ng-template #noSelection>
      <app-detail-toolbar>
        Select a command
      </app-detail-toolbar>
    </ng-template>
  </app-detail-pane>

  <div class="table-wrapper">
    <div class="panel-content">
      <table mat-table
             *ngIf="!dataSource.isEmpty(); else empty"
             [dataSource]="dataSource"
             class="ya-data-table">

        <ng-container matColumnDef="completion">
          <th mat-header-cell *matHeaderCellDef class="status"></th>
          <td mat-cell *matCellDef="let item" class="status">
            <ng-container *ngIf="item.completed && item.success">
              <mat-icon class="success" matTooltip="Completed">
                check_circle
              </mat-icon>
            </ng-container>
            <ng-container *ngIf="item.completed && !item.success">
              <mat-icon class="alert" [matTooltip]="item.failureMessage">
                highlight_off
              </mat-icon>
            </ng-container>
            <ng-container *ngIf="!item.completed">
              <mat-icon class="down">
                lens
              </mat-icon>
            </ng-container>
          </td>
        </ng-container>

        <ng-container matColumnDef="generationTimeUTC">
          <th mat-header-cell *matHeaderCellDef style="width: 200px">Time</th>
          <td mat-cell *matCellDef="let item">
            {{ item.generationTime | datetime }}
          </td>
        </ng-container>

        <ng-container matColumnDef="comment">
          <th mat-header-cell *matHeaderCellDef style="width: 30px; text-align: center">
            <mat-icon matTooltip="Comment">comment</mat-icon>
          </th>
          <td mat-cell *matCellDef="let item" style="text-align: center">
            <mat-icon *ngIf="item.comment" [matTooltip]="item.comment">comment</mat-icon>
            <ng-container *ngIf="!item.comment">-</ng-container>
          </td>
        </ng-container>

        <ng-container matColumnDef="command">
          <th mat-header-cell *matHeaderCellDef style="width: 350px">Command</th>
          <td mat-cell *matCellDef="let item">
            {{ item.source || '-' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="source">
          <th mat-header-cell *matHeaderCellDef style="width: 300px">Src</th>
          <td mat-cell *matCellDef="let item">
            {{ item.username }}<span *ngIf="item.origin">@{{ item.origin }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="sourceID">
          <th mat-header-cell *matHeaderCellDef style="width: 70px">Src.ID</th>
          <td mat-cell *matCellDef="let item">
            {{ item.sequenceNumber }}
          </td>
        </ng-container>

        <ng-container matColumnDef="stages">
          <th mat-header-cell *matHeaderCellDef>Stages</th>
          <td mat-cell *matCellDef="let item">
            <ng-container *ngFor="let step of item.stages">
              {{ step.name }}:
              <ng-container [ngSwitch]="step.status">
                <ng-container *ngSwitchCase="'OK'">
                  <mat-icon class="step success" [matTooltip]="step.name + ': OK'" style="margin-right: 8px">
                    check_circle
                  </mat-icon>
                </ng-container>
                <ng-container *ngSwitchCase="'TIMEOUT'">
                  <mat-icon class="step alert" [matTooltip]="step.name + ': TIMEOUT'" style="margin-right: 8px">
                    timer_off
                  </mat-icon>
                </ng-container>
                <ng-container *ngSwitchDefault>
                  <mat-icon class="step alert" [matTooltip]="step.name + ': ' + step.status" style="margin-right: 8px">
                    highlight_off
                  </mat-icon>
                </ng-container>
              </ng-container>
            </ng-container>
            <ng-container *ngIf="!item.stages.length">-</ng-container>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                 (click)="selectRecord(row)"
                 [class.selected]="(selectedRecord$ | async) === row">
        </tr>
      </table>

      <ng-template #empty>
        <app-empty-message *ngIf="!(dataSource.loading$ | async)">
          No entries in command history.
        </app-empty-message>
      </ng-template>
    </div>
  </div>
</app-instance-page>
